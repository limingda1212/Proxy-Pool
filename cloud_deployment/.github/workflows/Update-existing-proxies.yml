name: Update existing proxies

on:
  schedule:
    - cron: '0 5 * * *'  # æ¯å¤©UTCæ—¶é—´5:00è¿è¡Œ
  workflow_dispatch:

jobs:
  update-existing-proxies:
    runs-on: ubuntu-latest
    timeout-minutes: 240
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install dependencies
      run: |
        pip install -i https://pypi.tuna.tsinghua.edu.cn/simple/ requests aiohttp PySocks
        # éªŒè¯å®‰è£…
        python -c "import socks; print('PySocks å®‰è£…æˆåŠŸï¼ŒSOCKSä»£ç†æ”¯æŒå·²å¯ç”¨')"
        
    - name: Configure Git
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        
    - name: Pull latest changes first
      run: |
        # å…ˆæ‹‰å–æœ€æ–°æ›´æ”¹ï¼Œç¡®ä¿å·¥ä½œæµåŸºäºŽæœ€æ–°ä»£ç è¿è¡Œ
        git pull origin main
        
    - name: Run update existing proxies
      run: |
        python actions_main.py update_existing_proxies
        
    - name: Check for remote changes
      id: check_remote
      run: |
        # æ£€æŸ¥åœ¨è¿è¡Œè„šæœ¬æœŸé—´æ˜¯å¦æœ‰æ–°çš„è¿œç¨‹æäº¤
        git fetch origin
        LOCAL=$(git rev-parse HEAD)
        REMOTE=$(git rev-parse origin/main)
        
        if [ "$LOCAL" = "$REMOTE" ]; then
          echo "has_remote_changes=false" >> $GITHUB_OUTPUT
          echo "âœ… æ— è¿œç¨‹æ›´æ”¹ï¼Œä½¿ç”¨æœ¬åœ°éªŒè¯çš„ proxies.csv"
        else
          echo "has_remote_changes=true" >> $GITHUB_OUTPUT
          echo "ðŸ”„ æ£€æµ‹åˆ°è¿œç¨‹æ›´æ”¹ï¼Œå°†ä½¿ç”¨è¿œç¨‹ç‰ˆæœ¬"
        fi
        
    - name: Pull and overwrite if conflicts
      if: steps.check_remote.outputs.has_remote_changes == 'true'
      run: |
        # æ”¾å¼ƒæœ¬åœ°ä¿®æ”¹ï¼Œä½¿ç”¨è¿œç¨‹æœ€æ–°ç‰ˆæœ¬
        git reset --hard origin/main
        echo "å·²ä½¿ç”¨è¿œç¨‹æœ€æ–°ç‰ˆæœ¬è¦†ç›–æœ¬åœ°ä¿®æ”¹"
        
    - name: Auto-commit proxy updates
      if: steps.check_remote.outputs.has_remote_changes == 'false'
      uses: stefanzweifel/git-auto-commit-action@v4
      with:
        repository: .
        file_pattern: 'proxies.csv'
        commit_message: 'ðŸ¤– Update existing proxies'
        commit_user_name: 'GitHub Actions'
        commit_user_email: 'actions@github.com'
